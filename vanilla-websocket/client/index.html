<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Vanilla JavaScript WebSocket</title>
        <meta name="description" content="ðŸ”Œ Example of a WebSocket client.">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <style>
        pre {
            display: inline-block;
        }
    </style>
    <script>
        console.log('Running JavaScript...');
        function addToView(content, elementId) {
            const now = new Date();
            
            let parentElement = document.getElementById(elementId);
            
            let contentElement = document.createElement('pre'); 
            let timestamp = document.createElement('span');
            timestamp.innerHTML = now.toLocaleTimeString();
            
            let wrapperElement = document.createElement('div');
            wrapperElement.appendChild(timestamp); 
            wrapperElement.appendChild(contentElement); 
            
            contentElement.innerHTML = content;
            parentElement.appendChild(wrapperElement); 
        }
        
        let webSocketUrl = 'wss://localhost:9000';
        let webSocket = null;
        
        function parse(string) {
            try {
            return JSON.parse(string);
            } catch (error) {
                console.error("Could not parse string to JSON.", { string });
            }
        }
        
        function stringify(object) {
            try {
            return JSON.stringify(object);
            } catch (error) {
                console.error("Could not stringify object.", { object });
            }
        }
        
        function connect() {
            webSocket = new WebSocket(webSocketUrl);
            webSocket.onopen = () => onOpen();
            webSocket.onclose = event => onClose(event);
            webSocket.onmessage = payload => onMessage(payload);
        }
        
        function onOpen() {
            console.log('Connection to WebSocket server.');
        }
        
        function onClose() {
            console.log('The connection to the WebSocket server was closed.');
        }
        
        function onMessage(message) {
            const parsedMessage = parse(message);
            console.log('Received a message from WebSocket server', { parsedMessage });
            addToView(message, 'messages-received');
        }
        
        function sendMessage(message) {
            console.log('Sending message to the WebSocket server', { message } );
            const stringifiedMessage = stringify(message);
            webSocket.send(stringifiedMessage)
            addToView(message, 'messages-sent');
        }
        
        // This is only useful to demonstrate WebSockets thanks to the JavaScript browser console.
        function bindToWindow() {
            window.client = {
                addToView,
                parse,
                stringify,
                connect,
                onOpen,
                onClose,
                onMessage,
                sendMessage
            };
            console.log('Functions related to the WebSocket have been bound to window.client.');
        }
        
        bindToWindow();
    </script>
    <body>
        <div id="app">
          <h1>WebSocket client</h1>
          <button onClick="connect()">Connect</button>
          <h2>#messages-sent</h2>
          <div id="messages-sent"></div>
          <h2>#messages-received</h2>
          <div id="messages-received"></div>
        </div>
    </body>
</html>
